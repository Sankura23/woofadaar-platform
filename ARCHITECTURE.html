<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Woofadaar System Architecture</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
            line-height: 1.6;
            color: #333;
            background: #fff;
        }
        
        h1 {
            color: #2563eb;
            border-bottom: 3px solid #2563eb;
            padding-bottom: 10px;
            font-size: 2.5em;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #1d4ed8;
            margin-top: 40px;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-left: 4px solid #3b82f6;
            padding-left: 15px;
        }
        
        h3 {
            color: #1e40af;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.4em;
        }
        
        h4 {
            color: #1e3a8a;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        .overview {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .critical {
            background: #fef2f2;
            border: 2px solid #fca5a5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .critical h3 {
            color: #dc2626;
            margin-top: 0;
        }
        
        .success {
            background: #f0fdf4;
            border-left: 4px solid #22c55e;
            padding: 15px;
            margin: 10px 0;
        }
        
        .warning {
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 10px 0;
        }
        
        .error {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
            padding: 15px;
            margin: 10px 0;
        }
        
        pre {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            overflow-x: auto;
            font-size: 14px;
        }
        
        code {
            background: #f1f5f9;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        th, td {
            border: 1px solid #d1d5db;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background: #f3f4f6;
            font-weight: 600;
            color: #374151;
        }
        
        .status-migrated {
            color: #22c55e;
            font-weight: bold;
        }
        
        .status-deprecated {
            color: #ef4444;
            font-weight: bold;
        }
        
        ul, ol {
            padding-left: 20px;
        }
        
        li {
            margin: 5px 0;
        }
        
        .page-break {
            page-break-before: always;
        }
        
        @media print {
            body {
                font-size: 12px;
                line-height: 1.4;
            }
            
            h1 {
                font-size: 24px;
            }
            
            h2 {
                font-size: 20px;
                margin-top: 30px;
            }
            
            h3 {
                font-size: 16px;
                margin-top: 20px;
            }
            
            .page-break {
                page-break-before: always;
            }
            
            pre {
                font-size: 10px;
                white-space: pre-wrap;
                word-wrap: break-word;
            }
        }
        
        .toc {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            margin: 30px 0;
        }
        
        .toc ul {
            list-style-type: none;
            padding-left: 0;
        }
        
        .toc li {
            margin: 8px 0;
        }
        
        .toc a {
            color: #2563eb;
            text-decoration: none;
        }
        
        .toc a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

<h1>ğŸ• Woofadaar System Architecture</h1>

<div class="overview">
    <h2>ğŸ¯ Overview</h2>
    <p>Woofadaar is a Next.js 15 web application serving as India's premier dog parent community platform. The system has been migrated from a <strong>demo storage system</strong> to a <strong>database-first architecture</strong> using PostgreSQL via Supabase with Prisma ORM.</p>
</div>

<div class="toc">
    <h3>ğŸ“‘ Table of Contents</h3>
    <ul>
        <li><a href="#current-state">Current System State</a></li>
        <li><a href="#database-schema">Database Schema</a></li>
        <li><a href="#authentication">Authentication System</a></li>
        <li><a href="#api-architecture">API Architecture</a></li>
        <li><a href="#frontend-architecture">Frontend Architecture</a></li>
        <li><a href="#data-flow">Data Flow Patterns</a></li>
        <li><a href="#file-structure">File Structure</a></li>
        <li><a href="#guidelines">Development Guidelines</a></li>
        <li><a href="#testing">Testing Checklist</a></li>
        <li><a href="#common-patterns">Common Patterns</a></li>
        <li><a href="#quick-reference">Quick Reference</a></li>
        <li><a href="#migration-status">Migration Status</a></li>
    </ul>
</div>

<div class="page-break"></div>

<div class="critical" id="current-state">
    <h2>ğŸš¨ CRITICAL: Current System State (Updated August 2025)</h2>
    
    <div class="success">
        <h3>âœ… PRODUCTION READY - Use Database APIs</h3>
        <ul>
            <li><strong>Authentication</strong>: Database-first with fallback to demo storage</li>
            <li><strong>User Management</strong>: Fully migrated to PostgreSQL</li>
            <li><strong>Appointments</strong>: Database-first system</li>
            <li><strong>Partner Management</strong>: Database-first system</li>
            <li><strong>Dog Profiles</strong>: Database-first system</li>
        </ul>
    </div>
    
    <div class="error">
        <h3>âŒ DEPRECATED - Demo Storage System</h3>
        <ul>
            <li><strong>DO NOT USE</strong> demo storage APIs for new development</li>
            <li>Demo storage exists only as fallback for legacy compatibility</li>
            <li>All new features MUST use database APIs</li>
        </ul>
    </div>
</div>

<div class="page-break"></div>

<section id="database-schema">
    <h2>ğŸ“Š Database Schema (PostgreSQL via Supabase)</h2>
    
    <h3>Core Tables</h3>
    <pre><code>-- Users (Pet Parents)
User {
  id: String @id
  email: String @unique
  name: String
  password_hash: String
  location: String?
  experience_level: String @default("beginner")
  barks_points: Int @default(0)
  is_premium: Boolean @default(false)
  profile_image_url: String?
  profile_visibility: String @default("public")
  reputation: Int @default(0)
  preferred_language: String @default("en")
  created_at: DateTime @default(now())
  updated_at: DateTime @updatedAt
}

-- Partners (Vets, Trainers, Corporate)
Partner {
  id: String @id @default(cuid())
  email: String @unique
  name: String
  password: String?
  partner_type: String // 'vet' | 'trainer' | 'corporate' | 'kci'
  business_name: String?
  location: String
  phone: String
  website: String?
  bio: String?
  specialization: Json?
  consultation_fee_range: Json?
  languages_spoken: String[]
  certifications: String[]
  verified: Boolean @default(false)
  status: String @default("pending") // 'pending' | 'approved' | 'rejected'
  partnership_tier: String @default("basic")
  rating_average: Float @default(0.0)
  total_appointments: Int @default(0)
  created_at: DateTime @default(now())
}

-- Dogs
Dog {
  id: String @id @default(cuid())
  user_id: String
  name: String
  breed: String
  age_months: Int
  weight_kg: Float
  gender: String
  vaccination_status: String
  spayed_neutered: Boolean
  health_id: String? @unique
  photo_url: String?
  emergency_contact: String?
  emergency_phone: String?
  medical_notes: String?
  personality_traits: String[]
  location: String?
  created_at: DateTime @default(now())
  updated_at: DateTime @updatedAt
}

-- Appointments
Appointment {
  id: String @id @default(cuid())
  partner_id: String
  user_id: String
  dog_id: String?
  appointment_date: DateTime
  duration_minutes: Int @default(60)
  service_type: String // 'consultation' | 'treatment' | 'training' | 'emergency'
  meeting_type: String // 'in_person' | 'video_call' | 'phone_call'
  consultation_fee: Float
  status: String @default("scheduled") // 'scheduled' | 'confirmed' | 'completed' | 'cancelled'
  notes: String?
  meeting_link: String?
  created_at: DateTime @default(now())
  updated_at: DateTime @updatedAt
}</code></pre>

    <h3>Database Connection</h3>
    <pre><code>DATABASE_URL="postgresql://postgres:projectWoof@251321@db.cqfgtugxcyjtxzvcshij.supabase.co:5432/postgres"</code></pre>
</section>

<div class="page-break"></div>

<section id="authentication">
    <h2>ğŸ” Authentication System</h2>
    
    <h3>JWT Token Structure</h3>
    <pre><code>// Pet Parent Token
{
  userId: "user-1755769240167-fgxpbr06x",
  email: "e@c.com",
  userType: "pet-parent",
  iat: 1755771265,
  exp: 1756376065
}

// Partner Token  
{
  partnerId: "partner-1755770019060-cybwvukre",
  email: "a@a.com", 
  userType: "partner",
  iat: 1755772456,
  exp: 1756377256
}</code></pre>

    <h3>Authentication Flow</h3>
    <ol>
        <li><strong>Login</strong>: <code>/api/auth/working-login</code> (Database-first with demo fallback)</li>
        <li><strong>User Profile</strong>: <code>/api/auth/working-user</code> (Database-first)</li>
        <li><strong>Partner Profile</strong>: <code>/api/auth/partner-me</code> (Database-first)</li>
        <li><strong>Dogs</strong>: <code>/api/auth/working-dogs</code> (Database-first)</li>
    </ol>
</section>

<div class="page-break"></div>

<section id="api-architecture">
    <h2>ğŸ›£ API Architecture</h2>
    
    <div class="success">
        <h3>âœ… PRODUCTION APIs (Database-First)</h3>
        
        <h4>Authentication</h4>
        <ul>
            <li><code>POST /api/auth/working-login</code> - Login for both pet parents and partners</li>
            <li><code>GET /api/auth/working-user</code> - Get user profile (pet parents)</li>
            <li><code>PUT /api/auth/working-user</code> - Update user profile (pet parents)</li>
            <li><code>GET /api/auth/partner-me</code> - Get partner profile</li>
            <li><code>GET /api/auth/working-dogs</code> - Get user's dogs</li>
            <li><code>POST /api/auth/working-dogs</code> - Create new dog</li>
        </ul>

        <h4>Partners</h4>
        <ul>
            <li><code>GET /api/partners</code> - Get all approved partners (public)</li>
            <li><code>GET /api/partners/bookings</code> - Get partner's appointments (authenticated)</li>
            <li><code>PUT /api/partners/bookings</code> - Update appointment status</li>
        </ul>

        <h4>Appointments</h4>
        <ul>
            <li><code>POST /api/appointments/book</code> - Book appointment with partner</li>
            <li><code>GET /api/appointments/book</code> - Get available time slots</li>
        </ul>
    </div>

    <div class="error">
        <h3>âŒ DEPRECATED APIs (Demo Storage)</h3>
        <ul>
            <li><code>/api/partner/appointments</code> - DO NOT USE (uses demo data)</li>
            <li>Any API using <code>@/lib/demo-storage</code> functions</li>
        </ul>
    </div>
</section>

<div class="page-break"></div>

<section id="frontend-architecture">
    <h2>ğŸ¨ Frontend Architecture</h2>
    
    <h3>Key Pages & Components</h3>
    
    <h4>Pet Parent Flow</h4>
    <pre><code>/login â†’ /profile â†’ /profile/dogs/add â†’ /partners/directory â†’ /appointments/book</code></pre>

    <h4>Partner Flow</h4>
    <pre><code>/login â†’ /partner/dashboard â†’ /partner/appointments</code></pre>

    <h3>Component Data Flow</h3>
    <pre><code>// âœ… CORRECT: Database API Usage
const fetchUserData = async () => {
  const response = await fetch('/api/auth/working-user', {
    headers: { 'Authorization': `Bearer ${token}` }
  });
  const data = await response.json();
  return data.user;
};

// âŒ WRONG: Demo Storage Usage
const fetchOldWay = async () => {
  // Don't use endpoints that still use demo storage
};</code></pre>
</section>

<section id="data-flow">
    <h2>ğŸ”„ Data Flow Patterns</h2>
    
    <h3>User Registration & Login</h3>
    <ol>
        <li>User registers/logs in via <code>/api/auth/working-login</code></li>
        <li>JWT token stored in localStorage as 'woofadaar_token'</li>
        <li>Frontend components use token for authenticated requests</li>
        <li>Database-first lookup with demo storage fallback</li>
    </ol>

    <h3>Appointment Booking</h3>
    <ol>
        <li>Pet parent browses <code>/api/partners</code> (database partners)</li>
        <li>Selects partner and books via <code>/api/appointments/book</code></li>
        <li>Appointment stored in database with proper relations</li>
        <li>Partner views appointments via <code>/api/partners/bookings</code></li>
    </ol>

    <h3>Frontend State Management</h3>
    <ul>
        <li>localStorage for JWT tokens and user type</li>
        <li>React useState for component state</li>
        <li>No global state management (Redux/Zustand)</li>
    </ul>
</section>

<div class="page-break"></div>

<section id="file-structure">
    <h2>ğŸ“ File Structure</h2>
    
    <pre><code>woofadaar1/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ working-login/route.ts        âœ… Database-first
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ working-user/route.ts         âœ… Database-first  
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ partner-me/route.ts           âœ… Database-first
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ working-dogs/route.ts         âœ… Database-first
â”‚   â”‚   â”‚   â”œâ”€â”€ partners/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ route.ts                      âœ… Database-first
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ bookings/route.ts             âœ… Database-first
â”‚   â”‚   â”‚   â”œâ”€â”€ appointments/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ book/route.ts                 âœ… Database-first
â”‚   â”‚   â”‚   â””â”€â”€ partner/
â”‚   â”‚   â”‚       â””â”€â”€ appointments/route.ts         âŒ Deprecated
â”‚   â”‚   â”œâ”€â”€ partner/
â”‚   â”‚   â”‚   â”œâ”€â”€ dashboard/page.tsx
â”‚   â”‚   â”‚   â””â”€â”€ appointments/page.tsx             âœ… Fixed to use bookings API
â”‚   â”‚   â”œâ”€â”€ profile/page.tsx                      âœ… Uses working-user API
â”‚   â”‚   â””â”€â”€ partners/directory/page.tsx           âœ… Uses partners API
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ db.ts                                 âœ… Prisma client
â”‚   â”‚   â”œâ”€â”€ auth.ts                               âœ… JWT utilities
â”‚   â”‚   â””â”€â”€ demo-storage.ts                       âŒ Deprecated (fallback only)
â”‚   â””â”€â”€ components/
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma                             âœ… Source of truth
â”‚   â””â”€â”€ migrations/
â”œâ”€â”€ .env                                          âœ… Database config
â””â”€â”€ ARCHITECTURE.md                               ğŸ“š This document</code></pre>
</section>

<div class="page-break"></div>

<section id="guidelines">
    <h2>ğŸš€ Development Guidelines</h2>
    
    <div class="success">
        <h3>âœ… DO's</h3>
        <ol>
            <li><strong>Always use database-first APIs</strong> for new features</li>
            <li><strong>Check this architecture</strong> before starting any new development</li>
            <li><strong>Use Prisma client</strong> for database operations</li>
            <li><strong>Include proper error handling</strong> with database fallbacks</li>
            <li><strong>Test both frontend and backend</strong> before considering complete</li>
            <li><strong>Use proper JWT authentication</strong> for all protected routes</li>
            <li><strong>Transform data structures</strong> if frontend/backend schemas differ</li>
        </ol>
    </div>

    <div class="error">
        <h3>âŒ DON'Ts</h3>
        <ol>
            <li><strong>Never use demo storage</strong> for new features</li>
            <li><strong>Don't create duplicate APIs</strong> without checking existing ones</li>
            <li><strong>Don't skip database migrations</strong> when changing schema</li>
            <li><strong>Don't hardcode partner/user IDs</strong> in components</li>
            <li><strong>Don't mix demo and database data</strong> in the same API</li>
            <li><strong>Don't assume APIs work</strong> without testing the full flow</li>
        </ol>
    </div>
</section>

<section id="testing">
    <h2>ğŸ§ª Testing Checklist</h2>
    
    <h3>Authentication Flow</h3>
    <ul>
        <li>â˜ Pet parent can register/login with <code>working-login</code></li>
        <li>â˜ Partner can register/login with <code>working-login</code></li>
        <li>â˜ JWT tokens are properly formatted and stored</li>
        <li>â˜ Protected routes require valid authentication</li>
    </ul>

    <h3>User Management</h3>
    <ul>
        <li>â˜ Pet parent profile loads via <code>working-user</code></li>
        <li>â˜ Partner profile loads via <code>partner-me</code></li>
        <li>â˜ User data updates persist to database</li>
        <li>â˜ Dogs CRUD operations work via <code>working-dogs</code></li>
    </ul>

    <h3>Appointments Flow</h3>
    <ul>
        <li>â˜ Partner directory shows only approved partners from database</li>
        <li>â˜ Appointment booking creates records in database</li>
        <li>â˜ Partner can view appointments via <code>bookings</code> API</li>
        <li>â˜ Frontend transforms data correctly between APIs</li>
    </ul>

    <h3>Data Consistency</h3>
    <ul>
        <li>â˜ All user actions reflect immediately in UI</li>
        <li>â˜ Database and frontend stay in sync</li>
        <li>â˜ No duplicate records created</li>
        <li>â˜ Proper error handling with user feedback</li>
    </ul>
</section>

<div class="page-break"></div>

<section id="common-patterns">
    <h2>ğŸ— Common Patterns</h2>
    
    <h3>API Response Format</h3>
    <pre><code>// Success Response
{
  success: true,
  data: { /* actual data */ },
  message: "Operation successful"
}

// Error Response  
{
  success: false,
  message: "Error description",
  error: "Technical details"
}</code></pre>

    <h3>Authentication Header</h3>
    <pre><code>headers: {
  'Authorization': `Bearer ${localStorage.getItem('woofadaar_token')}`,
  'Content-Type': 'application/json'
}</code></pre>

    <h3>Database Query Pattern</h3>
    <pre><code>// Always include proper select and relations
const user = await prisma.user.findUnique({
  where: { id: userId },
  select: {
    id: true,
    name: true,
    email: true,
    // ... other fields
  }
});</code></pre>
</section>

<section id="quick-reference">
    <h2>ğŸ“ Quick Reference</h2>
    
    <h3>Active User Accounts</h3>
    <pre><code>// Pet Parent
email: "e@c.com"
password: "Password"
id: "user-1755769240167-fgxpbr06x"

// Partner (Vet)
email: "a@a.com" 
password: "Password"
id: "partner-1755770019060-cybwvukre"</code></pre>

    <h3>Database Connection Test</h3>
    <pre><code>node -e "
const { PrismaClient } = require('@prisma/client');
const prisma = new PrismaClient();
prisma.user.count().then(count => console.log('Users:', count));
"</code></pre>

    <h3>JWT Secret</h3>
    <pre><code>JWT_SECRET=woofadaar-super-secret-jwt-key-for-authentication-2024-india-dogs</code></pre>
</section>

<div class="page-break"></div>

<section id="migration-status">
    <h2>ğŸ¯ Migration Status</h2>
    
    <table>
        <thead>
            <tr>
                <th>Component</th>
                <th>Status</th>
                <th>API Endpoint</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Pet Parent Auth</td>
                <td><span class="status-migrated">âœ… Migrated</span></td>
                <td><code>/api/auth/working-login</code></td>
                <td>Database-first</td>
            </tr>
            <tr>
                <td>Partner Auth</td>
                <td><span class="status-migrated">âœ… Migrated</span></td>
                <td><code>/api/auth/working-login</code></td>
                <td>Database-first</td>
            </tr>
            <tr>
                <td>User Profile</td>
                <td><span class="status-migrated">âœ… Migrated</span></td>
                <td><code>/api/auth/working-user</code></td>
                <td>Database-first</td>
            </tr>
            <tr>
                <td>Partner Profile</td>
                <td><span class="status-migrated">âœ… Migrated</span></td>
                <td><code>/api/auth/partner-me</code></td>
                <td>Database-first</td>
            </tr>
            <tr>
                <td>Dogs Management</td>
                <td><span class="status-migrated">âœ… Migrated</span></td>
                <td><code>/api/auth/working-dogs</code></td>
                <td>Database-first</td>
            </tr>
            <tr>
                <td>Partner Directory</td>
                <td><span class="status-migrated">âœ… Migrated</span></td>
                <td><code>/api/partners</code></td>
                <td>Database-first</td>
            </tr>
            <tr>
                <td>Appointments</td>
                <td><span class="status-migrated">âœ… Migrated</span></td>
                <td><code>/api/partners/bookings</code></td>
                <td>Database-first</td>
            </tr>
            <tr>
                <td>Appointment Booking</td>
                <td><span class="status-migrated">âœ… Migrated</span></td>
                <td><code>/api/appointments/book</code></td>
                <td>Database-first</td>
            </tr>
        </tbody>
    </table>
</section>

<div class="page-break"></div>

<section>
    <h2>ğŸ“‹ Future Development Notes</h2>
    
    <h3>When Adding New Features:</h3>
    <ol>
        <li><strong>Check this document first</strong> - Don't assume anything about the current system</li>
        <li><strong>Use database-first approach</strong> - All new APIs should query PostgreSQL directly</li>
        <li><strong>Follow existing patterns</strong> - Use same authentication, error handling, and data transformation patterns</li>
        <li><strong>Test full user flows</strong> - From login to feature completion</li>
        <li><strong>Update this document</strong> - Add new APIs, components, and patterns</li>
    </ol>

    <h3>When Debugging Issues:</h3>
    <ol>
        <li><strong>Check API endpoint</strong> - Ensure frontend is calling the correct database API</li>
        <li><strong>Verify data transformation</strong> - Frontend/backend data structures may differ</li>
        <li><strong>Test authentication</strong> - Ensure JWT tokens are valid and properly formatted</li>
        <li><strong>Check database state</strong> - Verify data actually exists in PostgreSQL</li>
        <li><strong>Review logs</strong> - Both frontend console and server logs</li>
    </ol>
</section>

<footer style="margin-top: 60px; padding-top: 40px; border-top: 2px solid #e5e7eb; text-align: center; color: #6b7280;">
    <p><em>This architecture document is the single source of truth for Woofadaar's system design. Always refer to this before making changes or adding features.</em></p>
    <p><strong>Last updated: August 2025</strong></p>
</footer>

</body>
</html>